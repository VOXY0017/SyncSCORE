/**
 * This ruleset enforces a public, read-only security model for a real-time scoreboard application.
 *
 * Core Philosophy:
 * The primary goal is to allow any user (authenticated or anonymous) to view player scores,
 * supporting features like public leaderboards. However, to maintain data integrity, all direct
 * client-side writes to player scores are currently disallowed. This creates a secure-by-default
 * posture, assuming that score updates will be handled by a trusted backend service or Cloud Function.
 *
 * Data Structure:
 * All player data is stored in a single top-level collection: /players/{playerId}.
 * Each player has a sub-collection for their score history: /players/{playerId}/scoreHistory/{historyId}.
 *
 * Key Security Decisions:
 * - Public Read Access: The /players collection is publicly readable to anyone to facilitate a global scoreboard.
 * - Write Operations Disabled: Direct client-side creation, updates, and deletion of player documents are
 *   explicitly disabled. This is a critical security measure because the 'Player' entity in the data model
 *   lacks an 'ownerId' or 'creatorId' field, making it impossible to securely authorize which user is
 *   allowed to modify a specific score.
 * - Collection Group Access: A specific rule is added for the 'scoreHistory' collection group to allow the
 *   global history feed to function.
 *
 * Denormalization for Authorization:
 * The current ruleset is simple and does not require denormalization. However, if write access were to be
 * enabled, it would be critical to add an ownership field (e.g., 'ownerId') directly to each 'Player' document.
 * This would allow for a simple, performant rule like 'allow update: if request.auth.uid == resource.data.ownerId;'
 * without needing costly 'get()' calls to other documents.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    // These functions provide reusable logic for common authorization patterns.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation for document ownership rules.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description
     * Allows public read access for a global scoreboard and allows authenticated users to write.
     * Also allows reading from the scoreHistory sub-collection.
     *
     * @path /players/{playerId}
     *
     * @allow (get, list) Any user, signed in or not, can read player score data.
     * @allow (create, update, delete) Any signed-in user can manage player data.
     *
     */
    match /players/{playerId} {
      allow read: if true;
      allow write: if isSignedIn();

      /**
       * @description
       * Allows signed-in users to read score history for an individual player
       * and allows the system to write new history entries.
       *
       * @path /players/{playerId}/scoreHistory/{historyId}
       */
      match /scoreHistory/{historyId} {
        allow read, write: if isSignedIn();
      }
    }
    
    /**
     * @description
     * This rule allows a collection group query on 'scoreHistory'. It is essential for the
     * global score history feature on the main page. It allows any signed-in user
     * to read from any 'scoreHistory' collection across all players.
     *
     * @path /players/{playerId}/scoreHistory/{historyId}
     */
    match /{path=**}/scoreHistory/{historyId} {
        allow read: if isSignedIn();
    }
  }
}
